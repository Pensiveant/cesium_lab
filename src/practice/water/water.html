<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>水流箭头</title>
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script src="../../demo/js/importCesium.js"></script>
  <style>
    html,
    body {
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
    }

    #cesiumContainer {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    import createViewer from "../../demo/js/initViewer.js";
    const viewer = createViewer({
      showTerrain: false,
      isPositionPick: true,
    });



    let pointGeojson = Cesium.GeoJsonDataSource.load(
      "./data/road.json",
      {
        fill: Cesium.Color.RED,
        stroke: Cesium.Color.BLUE,
        strokeWidth: 10,
        clampToGround: true
      }
    ).then((dataSource) => {
      viewer.dataSources.add(dataSource);

      var entities = dataSource.entities.values;
      for (var i = 0; i < entities.length; i++) {
        var entity = entities[i];
        // entity.polygon.material = texture();
       
        let positions = entity.polyline.positions.getValue();
        // 将笛卡尔转换为经纬度
        let coordinates = positions.map(function (position) {
          var cartographic = Cesium.Cartographic.fromCartesian(position);
          return [
            Cesium.Math.toDegrees(cartographic.longitude),
            Cesium.Math.toDegrees(cartographic.latitude),
          ];
        });
        // 使用turf,计算线段长度
        let line = turf.lineString(coordinates);
        let length = turf.length(line, { units: "kilometers" });
       
        entity.polyline.material = texture("#99FFFF",length*1000);
        entity.polyline.width = 20;
      }

      viewer.flyTo(dataSource);


    });


    function texture(color, duration) {
      // 动态纹理
      function PolylineTrailLinkMaterialProperty(color, duration) {
        this._definitionChanged = new Cesium.Event();
        this._color = undefined;
        this._colorSubscription = undefined;
        this.color = color;
        this.duration = duration;
        this._time = (new Date()).getTime();
      }
      Object.defineProperties(PolylineTrailLinkMaterialProperty.prototype, {
        isConstant: {
          get: function () {
            return false;
          }
        },
        definitionChanged: {
          get: function () {
            return this._definitionChanged;
          }
        },
        color: Cesium.createPropertyDescriptor('color')
      });
      PolylineTrailLinkMaterialProperty.prototype.getType = function (time) {
        return 'PolylineTrailLink';
      }
      PolylineTrailLinkMaterialProperty.prototype.getValue = function (time, result) {
        if (!Cesium.defined(result)) {
          result = {};
        }
        result.color = Cesium.Property.getValueOrClonedDefault(this._color, time, Cesium.Color.WHITE, result.color);
        result.image = Cesium.Material.PolylineTrailLinkImage;
        result.time = (((new Date()).getTime() - this._time) % this.duration) / this.duration;
        return result;
      }
      PolylineTrailLinkMaterialProperty.prototype.equals = function (other) {
        return this === other ||
          (other instanceof PolylineTrailLinkMaterialProperty &&
            Property.equals(this._color, other._color))
      }
      Cesium.PolylineTrailLinkMaterialProperty = PolylineTrailLinkMaterialProperty;
      Cesium.Material.PolylineTrailLinkType = 'PolylineTrailLink';
      // Cesium.Material.PolylineTrailLinkImage = "./img/w1.png";
      Cesium.Material.PolylineTrailLinkImage = "./img/arrow.png";
      Cesium.Material.PolylineTrailLinkSource = "czm_material czm_getMaterial(czm_materialInput materialInput)\n\
                                                  {\n\
                                                       czm_material material = czm_getDefaultMaterial(materialInput);\n\
                                                       vec2 st = repeat * materialInput.st;\n\
                                                       vec4 colorImage = texture(image, vec2(fract(st.s - time), st.t));\n\
                                                       material.alpha = colorImage.a * color.a;\n\
                                                       material.diffuse = (colorImage.rgb+color.rgb)/2.0;\n\
                                                       return material;\n\
												   }";

      Cesium.Material._materialCache.addMaterial(
        Cesium.Material.PolylineTrailLinkType,
        {
          fabric: {
            type: Cesium.Material.PolylineTrailLinkType,
            uniforms: {
              color: new Cesium.Color(1.0, 0.0, 0.0, 0.5),
              image: Cesium.Material.PolylineTrailLinkImage,
              time: 1000,
              repeat: new Cesium.Cartesian2(10, 1),
            },
            source: Cesium.Material.PolylineTrailLinkSource,
          },
          translucent: function (material) {
            return true;
          },
        }
      );
      // return new Cesium.PolylineTrailLinkMaterialProperty(
      //   Cesium.Color.fromCssColorString("#99FFFF"),
      //   10000
      // );
      return new Cesium.PolylineTrailLinkMaterialProperty(
        Cesium.Color.fromCssColorString(color),
        duration
      );
    }
  </script>
</body>

</html>